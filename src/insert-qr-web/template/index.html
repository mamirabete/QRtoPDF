<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insertar QR en PDF (Web)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <h2>Insertar QR en PDF (Flask)</h2>
  <p class="muted">
    {{ "Config cargado desde: " + config_path if has_config else "No se detectó config.json; se usan valores por defecto." }}
  </p>

  {% if not token %}
    <div class="card">
      <h3>1) Subir PDF</h3>
      <form action="/upload" method="post" enctype="multipart/form-data">
        <label>PDF</label>
        <input type="file" name="pdf" accept="application/pdf" required />
        <div style="margin-top:12px;">
          <button type="submit">Subir y abrir editor</button>
        </div>
      </form>
    </div>
  {% else %}

    <!-- Data para el JS -->
    <div id="appData" data-token="{{ token }}" data-pages="{{ pages }}"></div>

    <div class="grid">
      <div class="card">
        <h3>2) Parámetros</h3>

        <form id="applyForm" action="/apply/{{token}}" method="post">
          <label>URL</label>
          <input name="url" id="url" placeholder="https://..." required />

          <label>Página</label>
          <input name="page" id="page" type="number" min="1" max="{{pages}}" value="{{defaults.page}}" />

          <div class="row">
            <div>
              <label>X</label>
              <input name="x" id="x" type="number" step="0.001" value="{{defaults.x}}" />
            </div>
            <div>
              <label>Y</label>
              <input name="y" id="y" type="number" step="0.001" value="{{defaults.y}}" />
            </div>
          </div>

          <label>Unidad (X/Y)</label>
          <select name="unit" id="unit">
            <option value="cm" {{ "selected" if defaults.unit=="cm" else "" }}>cm</option>
            <option value="mm" {{ "selected" if defaults.unit=="mm" else "" }}>mm</option>
            <option value="pt" {{ "selected" if defaults.unit=="pt" else "" }}>pt</option>
          </select>

          <div class="row">
            <div>
              <label>Tamaño (lado)</label>
              <input name="size" id="size" type="number" step="0.001" value="{{defaults.size}}" />
            </div>
            <div>
              <label>Unidad tamaño</label>
              <select name="size_unit" id="size_unit">
                <option value="cm" {{ "selected" if defaults.size_unit=="cm" else "" }}>cm</option>
                <option value="mm" {{ "selected" if defaults.size_unit=="mm" else "" }}>mm</option>
                <option value="pt" {{ "selected" if defaults.size_unit=="pt" else "" }}>pt</option>
              </select>
            </div>
          </div>

          <hr />

          <h4>Validación (A4/Carta)</h4>
          <label>Tolerancia (pt)</label>
          <input name="tol_pt" id="tol_pt" type="number" step="0.01" value="{{validation.tol_pt}}" />

          <label>paper_check</label>
          <select name="paper_check" id="paper_check">
            <option value="warn" {{ "selected" if validation.paper_check=="warn" else "" }}>warn</option>
            <option value="strict" {{ "selected" if validation.paper_check=="strict" else "" }}>strict</option>
          </select>

          <label>paper_dim_mode</label>
          <select name="paper_dim_mode" id="paper_dim_mode">
            <option value="visible" {{ "selected" if validation.paper_dim_mode=="visible" else "" }}>visible</option>
            <option value="mediabox" {{ "selected" if validation.paper_dim_mode=="mediabox" else "" }}>mediabox</option>
          </select>

          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" name="check_all_pages" id="check_all_pages" {{ "checked" if validation.check_all_pages else "" }} />
            Validar todas las páginas
          </label>

          <div style="margin-top: 14px;">
            <button type="submit">Insertar QR y generar PDF</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Tip: mové el rectángulo rojo. Estiralo desde las esquinas para cambiar el tamaño proporcionalmente.
          </p>
        </form>
      </div>

      <div class="previewWrap">
        <h3>3) Previsualización</h3>

        <div class="toolbar">
          <button type="button" id="btnReload">Recargar página</button>
          <button type="button" id="zoomOut">-</button>
          <span id="zoomLabel" class="muted">Zoom: 100%</span>
          <button type="button" id="zoomIn">+</button>
          <span class="muted" id="cursorInfo" style="margin-left:auto;">Cursor: —</span>
        </div>

        <div class="viewerOuter">
          <div class="viewer" id="viewer">
            <img id="pageImg" alt="Preview" />
            <div id="qrOverlay">
              <div class="badge">QR</div>
              <div class="handle tl" data-handle="tl"></div>
              <div class="handle tr" data-handle="tr"></div>
              <div class="handle bl" data-handle="bl"></div>
              <div class="handle br" data-handle="br"></div>
            </div>
          </div>
        </div>

        <p class="muted" id="pageMeta"></p>
      </div>
    </div>

    <!-- JS externo -->
    <script src="{{ url_for('static', filename='editor.js') }}"></script>
  {% endif %}
</body>
</html>
